{% extends 'base.html' %}
{% block title %}{{ profile_user.username }} – Instaclone{% endblock %}

{% block content %}
<div class="container">
  <div class="row mb-4">
    <div class="col-md-3 text-center">
      <img src="{{ profile.avatar.url }}"
           class="rounded-circle img-fluid"
           style="max-width:150px;"
           alt="Avatar {{ profile_user.username }}">
    </div>
    <div class="col-md-6">
          <h2 class="mb-0">{{ profile_user.username }}</h2>
          {% if request.user == profile_user %}
            <a href="{% url 'settings' %}" class="btn btn-outline-light btn-sm">Upravit profil</a>
          {% endif %}
          <ul class="list-inline">
          <strong id="post-count">{{ post_count }}</strong> příspěvků</li>
          <li class="list-inline-item">
            <strong id="followers-count">{{ profile.followers.count }}</strong> sledujících
          </li>
          <li class="list-inline-item">
            <strong id="following-count">{{ following_count }}</strong> sleduje
          </li>
        </ul>

        {% if request.user.is_authenticated and request.user != profile_user %}
          {% if profile in request.user.profile.following.all %}
            <button id="follow-btn" class="btn btn-sm btn-secondary">Unfollow</button>
          {% else %}
            <button id="follow-btn" class="btn btn-sm btn-primary">Follow</button>
          {% endif %}
        {% endif %}

        {% if profile.bio %}
            <p>{{ profile.bio }}</p>
        {% endif %}
    </div>
  </div>

    <h4>Příspěvky</h4>
        <div class="row row-cols-1 row-cols-md-3 g-3">
          {% for post in posts %}
            <div class="col">
              <a href="{% url 'post_detail' post.pk %}">
                <img src="{{ post.image.url }}" class="img-fluid rounded" alt="Post">
              </a>
            </div>
          {% empty %}
            <p>Žádné příspěvky.</p>
          {% endfor %}
        </div>

</div>
{% endblock %}
{% block extra_js %}
<script>
const csrftoken = '{{ csrf_token }}';
const btn = document.getElementById('follow-btn');
if (btn) {
  btn.addEventListener('click', async () => {
    const username = "{{ profile_user.username }}";
    const res = await fetch(
  `/api/profile/${username}/follow-toggle/`,
  {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    },
  }
);

    if (!res.ok) {
      alert('Chyba při odesílání požadavku');
      return;
    }
    const data = await res.json();
    if (data.action === 'followed') {
      btn.textContent = 'Unfollow';
      btn.classList.remove('btn-primary');
      btn.classList.add('btn-secondary');
    } else {
      btn.textContent = 'Follow';
      btn.classList.remove('btn-secondary');
      btn.classList.add('btn-primary');
    }
    document.getElementById('followers-count').textContent = data.followers_count;
    document.getElementById('following-count').textContent = data.following_count;
  });
}
</script>
{% endblock %}

